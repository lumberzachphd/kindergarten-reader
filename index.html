<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sight Words!</title>
    
    <link rel="apple-touch-icon" href="https://via.placeholder.com/180/000000/FFFFFF?text=Sight+Words!">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <style>
        :root {
            --primary: #5D9CEC;
            --success: #48CFAD;
            --danger: #ED5565;
            --background: #121212;
            --card-bg: #1E1E1E;
            --text-main: #FFFFFF;
            --text-muted: #A0A0A0;
            --border-color: #333;
            
            /* Character Colors */
            --char-skin: #FFDFC4;
            --char-hair: #8D5524;
            --char-shirt: #3498db;
            --char-pants: #333;
        }

        * { box-sizing: border-box; }

        body {
            font-family: 'Comic Sans MS', 'Chalkboard SE', sans-serif;
            background-color: var(--background);
            color: var(--text-main);
            margin: 0;
            display: flex;
            flex-direction: column;
            height: 100dvh;
            overflow: hidden;
            touch-action: manipulation;
        }

        /* --- MODAL (Leaderboard Popup) --- */
        .modal {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            backdrop-filter: blur(5px);
        }
        .hidden { display: none !important; }
        
        .modal-card {
            background: var(--card-bg);
            width: 100%;
            max-width: 400px;
            border-radius: 20px;
            border: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            position: relative;
            max-height: 80vh;
        }
        
        .modal-header {
            padding: 15px;
            border-bottom: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .btn-close {
            background: #444;
            color: white;
            border: none;
            width: 35px; height: 35px;
            border-radius: 50%;
            font-size: 1.2rem;
            cursor: pointer;
        }

        /* --- START SCREEN --- */
        #start-screen {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: var(--background);
            z-index: 100;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 10px;
        }

        .setup-card {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 20px;
            text-align: center;
            width: 100%;
            max-width: 450px;
            max-height: 95vh;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .setup-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            width: 100%;
            align-items: start;
        }
        
        .char-column {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .leaderboard-column {
            background: rgba(0,0,0,0.3);
            border-radius: 15px;
            padding: 15px;
            width: 100%;
            height: 100%;
            min-height: 250px;
            display: flex;
            flex-direction: column;
        }
        
        .leaderboard-content {
            flex: 1;
            width: 100%;
        }

        /* Live Preview Container */
        .preview-container {
            width: 140px;
            height: 160px;
            margin-bottom: 15px;
            border-bottom: 4px solid #4CAF50;
            padding-bottom: 0px;
            background: linear-gradient(to bottom, #87CEEB 0%, #E0F7FA 100%);
            border-radius: 15px 15px 0 0;
            display: flex;
            justify-content: center;
            align-items: flex-end;
            position: relative;
            overflow: hidden;
        }

        h2 { margin: 0 0 10px 0; font-size: 1rem; color: var(--primary); text-transform: uppercase; letter-spacing: 1px; }
        p { margin: 8px 0 4px; font-size: 0.9rem; color: var(--text-muted); font-weight: bold;}

        input {
            padding: 12px;
            border-radius: 10px;
            border: 2px solid #555;
            background: #222;
            color: white;
            font-size: 1.5rem;
            margin: 5px 0;
            width: 90%;
            text-align: center;
            font-weight: bold;
        }
        
        .color-picker {
            display: flex;
            gap: 8px; 
            justify-content: center;
            margin: 5px 0;
            flex-wrap: wrap;
        }

        .color-dot {
            width: 28px; height: 28px;
            border-radius: 50%;
            border: 2px solid #555;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .color-dot:active { transform: scale(1.2); border-color: white; }

        .toggle-container {
            display: flex;
            background: #333;
            border-radius: 20px;
            padding: 4px;
            margin: 5px 0;
        }
        
        .toggle-btn {
            padding: 6px 15px;
            border-radius: 16px;
            border: none;
            background: transparent;
            color: #aaa;
            font-weight: bold;
            cursor: pointer;
            font-size: 0.8rem;
        }
        
        .toggle-btn.active {
            background: var(--primary);
            color: #121212;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }

        .btn-start {
            background: var(--success);
            color: #121212;
            border: none;
            padding: 12px 50px;
            border-radius: 30px;
            font-size: 1.8rem;
            margin-top: 20px;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 0 4px 0 rgba(0,0,0,0.3);
            width: 90%;
            grid-column: span 2; 
        }

        /* Leaderboard Table */
        .lb-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        .lb-table td { padding: 5px 0; border-bottom: 1px solid #444; }
        .lb-rank { width: 25px; font-weight: bold; color: var(--primary); }
        .lb-name { text-align: left; }
        .lb-score { text-align: right; font-weight: bold; color: var(--success); }
        .lb-empty { color: #666; font-style: italic; padding: 20px 0; text-align: center;}
        .lb-loading { text-align: center; color: var(--primary); padding: 20px; }

        @media (max-width: 600px) {
            .setup-grid { grid-template-columns: 1fr; }
            .btn-start { grid-column: span 1; }
            .leaderboard-column { margin-top: 20px; }
        }

        /* --- GAME UI --- */
        header {
            width: 100%;
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--card-bg);
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
            z-index: 20;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .mode-toggle {
            padding: 8px 16px;
            font-size: 0.9rem;
            background: var(--primary);
            color: #121212;
            font-weight: bold;
            border: none;
            border-radius: 20px;
            cursor: pointer;
        }
        
        .btn-lb-toggle {
            background: #F1C40F;
            color: #121212;
            border: none;
            width: 40px; height: 40px;
            border-radius: 50%;
            font-size: 1.2rem;
            cursor: pointer;
            display: flex; justify-content: center; align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.5);
        }

        main {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            padding: 20px;
            position: relative;
            z-index: 10;
        }

        .card {
            background: var(--card-bg);
            width: 100%;
            max-width: 500px;
            min-height: 40%;
            border-radius: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 20px;
            border: 1px solid var(--border-color);
        }

        .word-display { font-size: 4rem; font-weight: bold; margin-bottom: 20px; line-height: 1.1; }
        .word-display.sentence-mode { font-size: 2rem; }

        .controls-container { display: flex; flex-direction: column; gap: 15px; align-items: center; width: 100%; }
        .action-row { display: flex; gap: 30px; justify-content: center; }

        button {
            border: none; outline: none; cursor: pointer;
            display: flex; justify-content: center; align-items: center;
            box-shadow: 0 6px 0 rgba(0,0,0,0.4);
            transition: transform 0.1s;
        }
        button:active { transform: scale(0.95) translateY(4px); box-shadow: 0 2px 0 rgba(0,0,0,0.4); }

        .btn-round { width: 80px; height: 80px; border-radius: 50%; font-size: 2.5rem; color: #121212; }
        .btn-speak { background: var(--primary); width: 60px; height: 60px; font-size: 1.8rem; margin-top: 5px; }
        .btn-check { background: var(--success); }
        .btn-wrong { background: var(--danger); }
        
        .btn-restart {
            background: var(--primary);
            color: #121212;
            padding: 15px 30px;
            font-size: 1.5rem;
            border-radius: 30px;
            font-weight: bold;
            display: none; 
        }

        /* --- GAME WORLD --- */
        .track-container {
            width: 100%;
            height: 200px;
            position: relative;
            overflow: hidden;
            flex-shrink: 0;
            background: linear-gradient(to bottom, #87CEEB 0%, #E0F7FA 100%); 
            border-top: 4px solid #4A90E2;
        }

        .scenery-svg {
            position: absolute;
            bottom: 30px; 
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        .ground {
            position: absolute;
            bottom: 0;
            width: 100%;
            height: 35px;
            background: #795548;
            border-top: 8px solid #4CAF50;
            z-index: 4;
            background-image: repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(0,0,0,0.1) 10px, rgba(0,0,0,0.1) 20px);
        }

        .character-wrapper {
            width: 75px; 
            height: 100px;
            position: absolute;
            bottom: 28px;
            left: 10px;
            transition: left 0.5s ease-in-out, transform 0.3s;
            z-index: 10;
        }
        
        .char-shadow {
            width: 50px;
            height: 10px;
            background: rgba(0,0,0,0.2);
            border-radius: 50%;
            position: absolute;
            bottom: 2px;
            left: 12px;
            z-index: 9;
        }

        .char-trophy { position: absolute; font-size: 2.5rem; top: -15px; right: -20px; z-index: 12; display: none; }

        .char-svg { width: 100%; height: 100%; overflow: visible; }
        .skin-fill { fill: var(--char-skin); }
        .hair-fill { fill: var(--char-hair); }
        .shirt-fill { fill: var(--char-shirt); }
        .pants-fill { fill: var(--char-pants); }

        .hair-short { display: none; }
        .hair-long-front { display: none; }
        .hair-long-back { display: none; }
        
        body.style-short-hair .hair-short { display: block; }
        body.style-long-hair .hair-long-front { display: block; }
        body.style-long-hair .hair-long-back { display: block; }

        .obstacle { position: absolute; bottom: 35px; font-size: 2.5rem; z-index: 5; filter: drop-shadow(2px 4px 6px rgba(0,0,0,0.3)); }
        .finish-line { position: absolute; right: 10px; bottom: 35px; font-size: 3.5rem; z-index: 5; filter: drop-shadow(2px 4px 6px rgba(0,0,0,0.3)); }

        .idle-anim { animation: bounce 2s infinite ease-in-out; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-3px); } }

        .jump-anim { animation: jump 0.5s ease-out; }
        @keyframes jump { 0% { transform: translateY(0); } 50% { transform: translateY(-40px) translateX(10px); } 100% { transform: translateY(0); } }

        .shake-animation { animation: shake 0.5s; border: 5px solid var(--danger); }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        .correct-animation { border: 5px solid var(--success); transform: scale(1.02); }

        .dance-anim { animation: dance 0.6s infinite alternate ease-in-out; }
        @keyframes dance {
            0% { transform: translateY(0) rotate(-10deg); }
            100% { transform: translateY(-20px) rotate(10deg); }
        }
    </style>
</head>
<body class="style-short-hair"> 

<div id="lb-modal" class="modal hidden">
    <div class="modal-card">
        <div class="modal-header">
            <h2 style="margin:0">üèÜ Weekly Leaders</h2>
            <button class="btn-close" onclick="closeLeaderboard()">‚úñ</button>
        </div>
        <div id="modal-leaderboard-content" class="leaderboard-content">
            </div>
        <div style="text-align: center; padding-bottom: 15px; color: #888; font-size: 0.8rem;">
            Resets Every Monday
        </div>
    </div>
</div>

<div id="start-screen">
    <div class="setup-card">
        <div class="setup-grid">
            
            <div class="char-column">
                <div class="preview-container">
                    <svg class="char-svg" viewBox="0 0 100 120">
                        <path class="hair-fill hair-long-back" d="M24,40 Q15,65 25,82 Q50,88 75,82 Q85,65 76,40" />
                        
                        <rect x="35" y="85" width="13" height="25" class="pants-fill" rx="4"/>
                        <rect x="52" y="85" width="13" height="25" class="pants-fill" rx="4"/>
                        <path d="M33,110 Q41,115 49,110" stroke="#111" stroke-width="3" fill="none"/> 
                        <path d="M51,110 Q59,115 67,110" stroke="#111" stroke-width="3" fill="none"/>
                        
                        <rect x="25" y="55" width="50" height="40" rx="8" class="shirt-fill" />
                        <rect x="15" y="57" width="15" height="12" rx="5" class="shirt-fill" transform="rotate(20 15 57)"/>
                        <rect x="70" y="57" width="15" height="12" rx="5" class="shirt-fill" transform="rotate(-20 85 57)"/>
                        <circle cx="12" cy="67" r="6" class="skin-fill" />
                        <circle cx="88" cy="67" r="6" class="skin-fill" />
                        
                        <circle cx="50" cy="38" r="24" class="skin-fill" />
                        
                        <circle cx="42" cy="36" r="3" fill="white" /> <circle cx="42" cy="36" r="1.5" fill="black" />
                        <circle cx="58" cy="36" r="3" fill="white" /> <circle cx="58" cy="36" r="1.5" fill="black" />
                        <path d="M45,46 Q50,50 55,46" stroke="#333" stroke-width="2" fill="none" stroke-linecap="round"/>
                        
                        <path class="hair-fill hair-short" d="M24,35 Q24,8 50,8 Q76,8 76,35 Q76,25 50,25 Q24,25 24,35" />
                        <path class="hair-fill hair-long-front" d="M24,35 Q24,8 50,8 Q76,8 76,35 Q76,22 50,22 Q24,22 24,35" />
                    </svg>
                </div>

                <input type="text" id="player-name" placeholder="Name">
                
                <div class="toggle-container">
                    <button class="toggle-btn active" id="btn-short" onclick="setHairStyle('short')">Short</button>
                    <button class="toggle-btn" id="btn-long" onclick="setHairStyle('long')">Long</button>
                </div>

                <p>Hair</p>
                <div class="color-picker">
                    <div class="color-dot" style="background:#f1c40f" onclick="setHair('#f1c40f')"></div> 
                    <div class="color-dot" style="background:#e67e22" onclick="setHair('#e67e22')"></div> 
                    <div class="color-dot" style="background:#4a3b2a" onclick="setHair('#4a3b2a')"></div> 
                    <div class="color-dot" style="background:#000000" onclick="setHair('#000000')"></div> 
                    <div class="color-dot" style="background:#e91e63" onclick="setHair('#e91e63')"></div> 
                </div>
                
                <p>Skin</p>
                <div class="color-picker">
                    <div class="color-dot" style="background:#fce5cd" onclick="setSkin('#fce5cd')"></div> 
                    <div class="color-dot" style="background:#f4c7a6" onclick="setSkin('#f4c7a6')"></div> 
                    <div class="color-dot" style="background:#b47d57" onclick="setSkin('#b47d57')"></div> 
                    <div class="color-dot" style="background:#5f3e28" onclick="setSkin('#5f3e28')"></div> 
                </div>

                <p>Shirt</p>
                <div class="color-picker">
                    <div class="color-dot" style="background:#e74c3c" onclick="setShirt('#e74c3c')"></div> 
                    <div class="color-dot" style="background:#3498db" onclick="setShirt('#3498db')"></div> 
                    <div class="color-dot" style="background:#2ecc71" onclick="setShirt('#2ecc71')"></div> 
                    <div class="color-dot" style="background:#9b59b6" onclick="setShirt('#9b59b6')"></div> 
                </div>
            </div>

            <div class="leaderboard-column">
                <h2>üèÜ Weekly Leaders</h2>
                <div id="start-leaderboard-content" class="leaderboard-content">
                    <div class="lb-loading">Loading...</div>
                </div>
                <div style="font-size: 0.8rem; color: #888; margin-top: auto; padding: 10px; text-align: center;">Resets Every Monday</div>
            </div>

            <button class="btn-start" onclick="startGame()">Let's Go!</button>
        </div>
    </div>
</div>

<header>
    <div class="header-left">
        <div style="font-size: 1.2rem; font-weight: bold;">üë§ <span id="display-name">Player</span></div>
        <div style="font-size: 1rem; color: var(--success); font-weight: bold;">Weekly: <span id="weekly-score">0</span></div>
    </div>
    
    <div style="display:flex; gap:10px;">
        <button class="btn-lb-toggle" onclick="openLeaderboard()" title="View Leaderboard">üèÜ</button>
        <button class="mode-toggle" onclick="toggleMode()">Mode: Words</button>
    </div>
</header>

<main>
    <div class="card" id="card">
        <div class="word-display" id="display-text">Loading...</div>
        
        <div class="controls-container" id="game-controls">
            <div class="action-row">
                <button class="btn-round btn-wrong" onclick="markWrong()" aria-label="Incorrect">‚úñ</button>
                <button class="btn-round btn-check" onclick="markCorrect()" aria-label="Correct">‚úì</button>
            </div>
            <button class="btn-round btn-speak" onclick="speakText()" aria-label="Listen">üîä</button>
        </div>

        <button class="btn-restart" id="restart-btn" onclick="resetGame()">Play Again üîÑ</button>
    </div>
</main>

<div class="track-container" id="track">
    <svg class="scenery-svg" viewBox="0 0 1000 200" preserveAspectRatio="none">
        <path d="M0,200 L150,50 L400,180 L600,60 L850,190 L1000,200 Z" fill="#B3E5FC" />
        <path d="M0,200 Q250,100 500,160 T1000,160 V200 H0 Z" fill="#81C784" />
        <path d="M0,200 Q300,150 600,180 T1000,150 V200 H0 Z" fill="#66BB6A" />
        <g fill="white" opacity="0.6">
            <circle cx="100" cy="50" r="30" /> <circle cx="140" cy="50" r="40" /> <circle cx="180" cy="50" r="30" />
            <circle cx="600" cy="80" r="25" /> <circle cx="640" cy="80" r="35" /> <circle cx="680" cy="80" r="25" />
        </g>
    </svg>

    <div class="obstacle" style="left: 20%;">üçÑ</div>
    <div class="obstacle" style="left: 45%;">ü™®</div>
    <div class="obstacle" style="left: 70%;">ü™µ</div>
    <div class="finish-line" id="ground-trophy">üèÜ</div>

    <div class="ground"></div>

    <div class="character-wrapper idle-anim" id="character">
        <div class="char-shadow"></div>
        <div class="char-trophy" id="char-trophy">üèÜ</div>
        <svg class="char-svg" viewBox="0 0 100 120">
            <path class="hair-fill hair-long-back" d="M24,40 Q15,65 25,82 Q50,88 75,82 Q85,65 76,40" />
            
            <rect x="35" y="85" width="13" height="25" class="pants-fill" rx="4"/>
            <rect x="52" y="85" width="13" height="25" class="pants-fill" rx="4"/>
            <path d="M33,110 Q41,115 49,110" stroke="#111" stroke-width="3" fill="none"/> 
            <path d="M51,110 Q59,115 67,110" stroke="#111" stroke-width="3" fill="none"/>
            
            <rect x="25" y="55" width="50" height="40" rx="8" class="shirt-fill" />
            <rect x="15" y="57" width="15" height="12" rx="5" class="shirt-fill" transform="rotate(20 15 57)"/>
            <rect x="70" y="57" width="15" height="12" rx="5" class="shirt-fill" transform="rotate(-20 85 57)"/>
            <circle cx="12" cy="67" r="6" class="skin-fill" />
            <circle cx="88" cy="67" r="6" class="skin-fill" />
            
            <circle cx="50" cy="38" r="24" class="skin-fill" />
            
            <circle cx="42" cy="36" r="3" fill="white" /> <circle cx="42" cy="36" r="1.5" fill="black" />
            <circle cx="58" cy="36" r="3" fill="white" /> <circle cx="58" cy="36" r="1.5" fill="black" />
            <path d="M45,46 Q50,50 55,46" stroke="#333" stroke-width="2" fill="none" stroke-linecap="round"/>
            
            <path class="hair-fill hair-short" d="M24,35 Q24,8 50,8 Q76,8 76,35 Q76,25 50,25 Q24,25 24,35" />
            <path class="hair-fill hair-long-front" d="M24,35 Q24,8 50,8 Q76,8 76,35 Q76,22 50,22 Q24,22 24,35" />
        </svg>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, onValue, update, increment } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    // --- INTEGRATED KEYS ---
    const firebaseConfig = {
        apiKey: "AIzaSyDjjBo73WLJGrM9RHG16BSm9by8mizPa4s",
        authDomain: "kindergarten-reader.firebaseapp.com",
        databaseURL: "https://kindergarten-reader-default-rtdb.firebaseio.com",
        projectId: "kindergarten-reader",
        storageBucket: "kindergarten-reader.firebasestorage.app",
        messagingSenderId: "224702899339",
        appId: "1:224702899339:web:d9e9edab8b40de1483e08e",
        measurementId: "G-FDT770V70K"
    };

    let db;
    try {
        const app = initializeApp(firebaseConfig);
        db = getDatabase(app);
    } catch (e) {
        console.error("Firebase Error", e);
    }

    function getWeekID() {
        const d = new Date();
        d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
        const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
        const weekNum = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        return `week_${weekNum}_${d.getFullYear()}`;
    }

    window.saveScoreToFirebase = function(name, points) {
        if (!db || !name) return;
        const weekID = getWeekID();
        const updates = {};
        updates[`leaderboard/${weekID}/${name}`] = increment(points);
        update(ref(db), updates);
    };

    window.listenToLeaderboard = function() {
        if (!db) return;
        const weekID = getWeekID();
        const lbRef = ref(db, `leaderboard/${weekID}`);
        
        onValue(lbRef, (snapshot) => {
            const data = snapshot.val();
            // We now have two places to update: Start Screen & Modal
            const startContainer = document.getElementById('start-leaderboard-content');
            const modalContainer = document.getElementById('modal-leaderboard-content');
            
            let html = "";

            if (!data) {
                html = '<div class="lb-empty">New Week! Be the first.</div>';
            } else {
                const sorted = Object.entries(data).sort(([,a], [,b]) => b - a).slice(0, 5);
                html = '<table class="lb-table">';
                sorted.forEach(([name, score], index) => {
                    let rank = index + 1;
                    let icon = rank === 1 ? 'ü•á' : (rank === 2 ? 'ü•à' : (rank === 3 ? 'ü•â' : rank + '.'));
                    html += `<tr><td class="lb-rank">${icon}</td><td class="lb-name">${name}</td><td class="lb-score">${score}</td></tr>`;
                });
                html += '</table>';
                
                // Update personal score if name matches
                if (window.currentPlayerName && data[window.currentPlayerName]) {
                     document.getElementById('weekly-score').innerText = data[window.currentPlayerName];
                }
            }
            
            if(startContainer) startContainer.innerHTML = html;
            if(modalContainer) modalContainer.innerHTML = html;
        });
    }

    window.listenToLeaderboard();
</script>

<script>
    // --- Data ---
    const allWords = [
        "me", "at", "they", "look", "will", "has", "said", "was", "is", "and", 
        "I", "with", "can", "have", "go", "do", "she", "want", "am", "on", 
        "play", "you", "make", "my", "a", "like", "we", "see", "went", "what", 
        "he", "to", "it", "the", "are", "mom", "dad"
    ];

    const wordBank = {
        sub_singular: ["He", "She", "It", "Mom", "Dad"],
        sub_plural: ["We", "They", "You"],
        verb_transitive: ["see", "make", "have", "want", "like"],
        verb_movement: ["play", "look", "go"],
        object_person: ["me", "you", "Mom", "Dad", "it", "us", "them"], 
        modal: ["can", "will"]
    };

    const templates = [
        "[sub_singular] [modal] [verb_movement].",     
        "[sub_plural] [modal] [verb_transitive] it.",  
        "[sub_singular] went to [verb_movement].",     
        "I went to [verb_movement].",                   
        "[sub_plural] [verb_transitive] [object_person].", 
        "I [verb_transitive] [object_person].",            
        "[sub_singular] is with [object_person].",      
        "I am with [object_person].",                   
        "[sub_plural] are on it.",                      
        "Look at [object_person].",                     
        "Do you [verb_transitive] it?",                 
        "What do you [verb_transitive]?",               
        "[sub_singular] said to [verb_movement]."       
    ];

    let currentText = "";
    let isSentenceMode = false;
    let strugglePileWords = [];
    let strugglePileSentences = [];
    let celebrationInterval = null; 
    window.currentPlayerName = ""; 

    let correctWordsSet = new Set();
    const WORD_GOAL = allWords.length;
    let sentenceScore = 0;
    const SENTENCE_GOAL = 10; 

    window.onload = function() {
        const lastPlayer = localStorage.getItem('last_player_name');
        if (lastPlayer) document.getElementById('player-name').value = lastPlayer;
    };

    // --- Modal Functions ---
    function openLeaderboard() {
        document.getElementById('lb-modal').classList.remove('hidden');
    }
    
    function closeLeaderboard() {
        document.getElementById('lb-modal').classList.add('hidden');
    }

    function setSkin(color) { document.documentElement.style.setProperty('--char-skin', color); }
    function setHair(color) { document.documentElement.style.setProperty('--char-hair', color); }
    function setShirt(color) { document.documentElement.style.setProperty('--char-shirt', color); }
    
    function setHairStyle(style) {
        if (style === 'short') {
            document.body.classList.remove('style-long-hair');
            document.body.classList.add('style-short-hair');
            document.getElementById('btn-short').classList.add('active');
            document.getElementById('btn-long').classList.remove('active');
        } else {
            document.body.classList.remove('style-short-hair');
            document.body.classList.add('style-long-hair');
            document.getElementById('btn-long').classList.add('active');
            document.getElementById('btn-short').classList.remove('active');
        }
    }

    function startGame() {
        const nameInput = document.getElementById('player-name');
        window.currentPlayerName = nameInput.value.trim() || "Super Reader";
        localStorage.setItem('last_player_name', window.currentPlayerName);
        document.getElementById('display-name').innerText = window.currentPlayerName;
        document.getElementById('start-screen').style.display = 'none';
        nextItem();
    }

    function toggleMode() {
        isSentenceMode = !isSentenceMode;
        document.querySelector('.mode-toggle').innerText = isSentenceMode ? "Mode: Sentences" : "Mode: Words";
        const display = document.getElementById('display-text');
        
        if (isSentenceMode) display.classList.add('sentence-mode');
        else display.classList.remove('sentence-mode');
        
        resetGame();
    }

    function getRandom(arr) { return arr[Math.floor(Math.random() * arr.length)]; }

    function generateSentence() {
        let template = getRandom(templates);
        return template.replace(/\[(\w+)\]/g, (match, type) => {
            if (wordBank[type]) return getRandom(wordBank[type]);
            return match; 
        });
    }

    function nextItem() {
        const card = document.getElementById('card');
        card.classList.remove('correct-animation', 'shake-animation');

        let nextText = "";
        let attempts = 0;
        let currentStrugglePile = isSentenceMode ? strugglePileSentences : strugglePileWords;

        do {
            if (currentStrugglePile.length > 0 && Math.random() > 0.5) {
                nextText = getRandom(currentStrugglePile);
            } 
            else if (!isSentenceMode) {
                const unmastered = allWords.filter(w => !correctWordsSet.has(w));
                if (unmastered.length > 0) nextText = getRandom(unmastered);
                else nextText = getRandom(allWords);
            }
            else {
                nextText = generateSentence();
            }
            attempts++;
        } while (nextText === currentText && attempts < 10);

        currentText = nextText;
        document.getElementById('display-text').innerText = currentText;
    }

    function speakText() {
        window.speechSynthesis.cancel();
        const utterance = new SpeechSynthesisUtterance(currentText);
        utterance.rate = 0.7; 
        window.speechSynthesis.speak(utterance);
    }

    function markCorrect() {
        let currentStrugglePile = isSentenceMode ? strugglePileSentences : strugglePileWords;
        const pileIndex = currentStrugglePile.indexOf(currentText);
        if (pileIndex > -1) currentStrugglePile.splice(pileIndex, 1);

        if (window.saveScoreToFirebase) {
            window.saveScoreToFirebase(window.currentPlayerName, 1);
        }

        if (isSentenceMode) {
            sentenceScore++;
        } else {
            if (!correctWordsSet.has(currentText)) correctWordsSet.add(currentText);
        }
        
        updateCharacterPosition();

        const card = document.getElementById('card');
        card.classList.add('correct-animation');
        
        let hasWon = isSentenceMode ? (sentenceScore >= SENTENCE_GOAL) : (correctWordsSet.size >= WORD_GOAL);
        
        if (!hasWon) setTimeout(() => { nextItem(); }, 800); 
    }

    function markWrong() {
        if (isSentenceMode) {
            strugglePileSentences.push(currentText);
            strugglePileSentences.push(currentText);
        } else {
            strugglePileWords.push(currentText);
            strugglePileWords.push(currentText);
        }
        const card = document.getElementById('card');
        card.classList.add('shake-animation');
        setTimeout(() => { nextItem(); }, 1500);
    }

    function updateCharacterPosition() {
        const charEl = document.getElementById('character');
        let currentProgress, goal;
        
        if (isSentenceMode) {
            currentProgress = sentenceScore;
            goal = SENTENCE_GOAL;
        } else {
            currentProgress = correctWordsSet.size;
            goal = WORD_GOAL;
        }

        const hasWon = currentProgress >= goal;
        let leftPos;
        if (hasWon) {
            leftPos = "calc(100% - 70px)";
        } else {
            const maxPercent = 85; 
            let percent = (currentProgress / goal) * maxPercent;
            leftPos = `calc(${percent}% + 10px)`;
        }

        charEl.classList.remove('idle-anim');
        charEl.classList.add('jump-anim');
        charEl.style.left = leftPos;

        setTimeout(() => {
            charEl.classList.remove('jump-anim');
            if (hasWon) {
                triggerWin(); 
            } else {
                charEl.classList.add('idle-anim');
            }
        }, 500);
    }

    function triggerWin() {
        // --- PERSONALIZED MESSAGE ---
        document.getElementById('display-text').innerText = `Great work ${window.currentPlayerName}!`;
        
        document.getElementById('game-controls').style.display = 'none';
        document.getElementById('restart-btn').style.display = 'block';

        document.getElementById('ground-trophy').style.opacity = '0';
        document.getElementById('char-trophy').style.display = 'block';

        const charEl = document.getElementById('character');
        charEl.classList.add('dance-anim');

        confetti({ particleCount: 200, spread: 100, origin: { y: 0.6 } });
        
        if (celebrationInterval) clearInterval(celebrationInterval);
        celebrationInterval = setInterval(() => {
            confetti({ particleCount: 100, spread: 120, origin: { y: 0.7 } });
        }, 2000);
    }

    function resetGame() {
        if (celebrationInterval) clearInterval(celebrationInterval);
        correctWordsSet.clear();
        sentenceScore = 0;
        strugglePileWords = [];
        strugglePileSentences = [];
        
        document.getElementById('game-controls').style.display = 'flex';
        document.getElementById('restart-btn').style.display = 'none';
        
        const charEl = document.getElementById('character');
        charEl.style.left = '10px';
        charEl.classList.remove('dance-anim');
        charEl.classList.add('idle-anim');
        
        document.getElementById('char-trophy').style.display = 'none';
        document.getElementById('ground-trophy').style.opacity = '1';

        nextItem();
    }
</script>
</body>
</html>
